# Mesos代码结构

上一节中学习了CMake的相关知识，本节结合CMake和Mesos源码来对mesos的代码结构进行梳理，为后续的学习和使用打下基础。

对于c\/c++代码，项目编译链接过程很好地体现了整个代码的组织逻辑，但是没法体现动态的依赖关系。因此从编译链接过程来进一步理解整个工程依赖关系，比直接查看代码的目录结构更加清晰。本节从mesos的整体结构入手，通过静态目录和动态依赖关系两个角度来分析代码的组织结构，为理顺整个代码做些概念性的认识。

mesos源码地址:[https:\/\/github.com\/apache\/mesos](https://github.com/apache/mesos), 读者可以自己下载相关的代码。同时在mesos官网下载一份发布版的源代码。这两个版本的代码的区别在于，发布版的代码是打包后的可直接编译执行的代码。

阅读本节前建议先查看下mesos官方的开发者文档，从中也可以窥见mesos项目的特点，便于在后续的理解。

## 总体架构

mesos中有四个基本的角色：master, slave, freamework和executor。

* Mesos-master：负责管理framework和slave，收集slave上的资源信息，并将slave上的资源分配给各个framework
* Mesos-slave：管理Node节点上的各个mesos-task，同时为executor分配资源
* Framework：计算框架，如：Hadoop，Spark等，通过MesosSchedulerDiver接入Mesos
* Executor：执行器，用于启动计算框架中的task。

当用户试图添加一种新的计算框架到Mesos中时，需要实现一个Framework scheduler和executor以接入Mesos。  
![](architecture3.jpg)  
Mesos中按照资源的约束来为不同的框架提供不同的资源，计算框架获取资源后调度并执行对应的任务。  
![](architecture-example.jpg)  
reference:

[http:\/\/dongxicheng.org\/apache-mesos\/meso-architecture\/](http://dongxicheng.org/apache-mesos/meso-architecture/)  
[http:\/\/mesos.apache.org\/documentation\/latest\/architecture\/](http://mesos.apache.org/documentation/latest/architecture/)

## 目录结构说明

首先看下发布版的mesos代码和git版本的代码区别，基本的代码都是一样的，不同的是git代码中多出了cmake文件夹、以及其他和cmake相关的文件。这就意味着可以通过cmake来构建整个工程项目。\(这里发布版为什么不使用cmake？\)

整个代码的组织包括了三块 include, src, 3rdparty。mesos中使用的第三方库这里都是源码的形式存放在3rdparty目录下，使用的第三方库包括了libprocess, zookeeper, leveldb。

Zookeeper用于保证Master节点的高可用，保障主节点的可靠性，避免了单点故障。libprocess用于内部节点之间的数据通信和消息处理。

在具体的代码实现中围绕上面的四个角色和不同角色之间的关联来展开讨论。

## 依赖关系说明

依赖关系说明从CMakeList和Make过程来进行说明。下载git代码后，粗略浏览源码，发现源码中既包含了CMakeLists.txt以及Cmake文件夹，同时又包括了autoconf相关的文件。git版本的代码包含了两种方式的代码构建方式，一种是实用CMake，一种是AutoMake。发布版本都适用了AutoMake来编译，针对1.0版本后新增加了CMake方式，这也为跨平台（特别是Mesos On Windows平台提供了支持）。

### CMake编译

首先对，使用cmake对git源码进行编译：

```
mkdir build
cmake ..
make
```

打开文件夹可以看到，build下的代码相对源码少了很多了， 编译完成后，生成了静态的链接库libmesos libprocess libzookeeper liblevedb。

```
3rdparty
    leveldb
    zookeeper
    libprocess
  includ/mesos
  src
    master
      registry.pb.h
    slave
      containerizer
    message
      ...ph.h
```

仔细一看会发现cmake编译的代码基本都是pb.h或者pb.cpp结尾的文件，pb在这里就是protobuf。这就说明这些文件基本都是用于分布式系统之间的消息通信。联想到mesos对外要提供不同计算框架的支持，必然要提供对外的服务接口。因此这里编译的文件只是mesos的一个module，用于mesos对外的应用扩展。

### 使用Automake编译

```
mkdir build
../bootstarp
../configure
make
```

完整的编译整个项目最终生成可执行文件,这个过程和编译发布版代码是一样的。首先编译或安装第三方库：

* libprocess
* zookeeper
* leveldb-1.4
* distribute-0.6.26 pip wheel:python包管理工具

## CMake构建Mesos代码说明

### mesos源码编译

下载git源码后，在源码目录下：

```
mkdir build
cmake ..
```

cmake执行完成后，可以看到当前目录下的代码结构如下所示：

```
3rdparty
include
src
Makefile
CMakeCache.txt
cmake_install.cmake
CTestTestFile.cmake
```

编译完成后，进入src目录下：

```
# Start mesos master (Ensure work directory exists and has proper permissions).
$ ./mesos-master --ip=127.0.0.1 --work_dir=/var/lib/mesos

# Start mesos agent (Ensure work directory exists and has proper permissions).
$ ./mesos-agent --master=127.0.0.1:5050 --work_dir=/var/lib/mesos

＃ Test mesos master
$ ./test-framework --master=127.0.0.1:5050
```

### mesos源码组织
从mesos源码编译过程来梳理mesos源码的组织结构，以及mesos源码如何通过cmake来组织不同模块的依赖关系。

```
# THE MESOS PROJECT.
####################
cmake_minimum_required(VERSION 2.8.10)

project(Mesos)
set(MESOS_MAJOR_VERSION 1)
set(MESOS_MINOR_VERSION 2)
set(MESOS_PATCH_VERSION 0)
set(PACKAGE_VERSION
  ${MESOS_MAJOR_VERSION}.${MESOS_MINOR_VERSION}.${MESOS_PATCH_VERSION})

set(MESOS_PACKAGE_VERSION ${PACKAGE_VERSION})
set(MESOS_PACKAGE_SOVERSION 0)


# CMAKE MODULE SETUP.
#####################
# Paths that are searched when `include(...)` is called.
list(APPEND CMAKE_MODULE_PATH ${CMAKE_SOURCE_DIR}/cmake)
list(APPEND CMAKE_MODULE_PATH ${CMAKE_SOURCE_DIR}/3rdparty/cmake)
list(APPEND CMAKE_MODULE_PATH ${CMAKE_SOURCE_DIR}/3rdparty/libprocess/cmake)
list(APPEND CMAKE_MODULE_PATH ${CMAKE_SOURCE_DIR}/3rdparty/stout/cmake)
list(
  APPEND
  CMAKE_MODULE_PATH ${CMAKE_SOURCE_DIR}/3rdparty/libprocess/cmake/macros)
list(APPEND CMAKE_MODULE_PATH ${CMAKE_SOURCE_DIR}/src/cmake)
list(APPEND CMAKE_MODULE_PATH ${CMAKE_SOURCE_DIR}/src/examples/cmake)
list(APPEND CMAKE_MODULE_PATH ${CMAKE_SOURCE_DIR}/src/master/cmake)
list(APPEND CMAKE_MODULE_PATH ${CMAKE_SOURCE_DIR}/src/slave/cmake)
list(APPEND CMAKE_MODULE_PATH ${CMAKE_SOURCE_DIR}/src/tests/cmake)

# Macros.
include(Common)
include(External)
include(PatchCommand)
include(Versions)
include(VsBuildCommand)

# Configuration.
include(MesosConfigure)

# SUBDIRECTORIES.
#################
add_subdirectory(3rdparty)
add_subdirectory(src)

# TESTS.
########
add_custom_target(
  check ${STOUT_TESTS_TARGET}
  COMMAND ${PROCESS_TESTS_TARGET}
  COMMAND ${MESOS_TESTS_TARGET}
  DEPENDS ${STOUT_TESTS_TARGET} ${PROCESS_TESTS_TARGET}  ${MESOS_TESTS_TARGET}
  )
```




